---
- name: Include OS-specific variables.
  include_vars: "{{ ansible_os_family }}.yml"

- name: Check if teleport is installed.
  stat: "path=/usr/local/bin/teleport"
  register: teleport_bin

- name: Install make.
  package:
    name: make
    state: present

- name: Unarchive teleport.
  ansible.builtin.unarchive:
    src: "{{ teleport_url }}"
    dest: /tmp
    remote_src: yes
  when: not teleport_bin.stat.exists

- name: Create license file directory
  file:
    path: /var/lib/teleport
    state: directory
    owner: "root"
    group: "root"
  become: yes

- name: Copy license file directory
  template:
    src: "{{ teleport_license_file }}"
    dest:  /var/lib/teleport/license.pem
    owner: "root"
    group: "root"
    mode: 0600
  when: teleport_license_file is defined and teleport_auth_enabled is true

- name: Create temporary directory
  file:
    path: /tmp/teleport
    state: directory
  become: yes
  when: not teleport_bin.stat.exists

- name: Install teleport.
  command: >
    ./install
    chdir=/tmp/teleport
  become: yes
  when: not teleport_bin.stat.exists

- name: Create teleport config.
  template:
    src: "teleport.yaml.j2"
    dest: "{{ teleport_config_path }}"
    owner: "root"
    group: "root"
    mode: 0600

- name: Clean teleport cached items
  file:
    path: /var/lib/teleport
    state: absent
  become: yes
  when: teleport_clean_cache is true


- include_tasks: configure-Systemd.yml
  when: ansible_service_mgr == 'systemd'

- include_tasks: configure-Upstart.yml
  when: ansible_service_mgr == 'upstart'

- include_tasks: configure-Sysvinit.yml
  when: ansible_service_mgr == 'sysvinit'

- name: Ensure teleport has selected state and enabled on boot.
  service:
    name: 'teleport'
    state: 'started'
    enabled: yes
